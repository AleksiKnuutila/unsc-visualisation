<!DOCTYPE html>
<head>
  <script src="vendor/jquery-2.1.0.js"></script>
  <script src="vendor/jquery.mousewheel.js"></script>
  <link href="vendor/select2.css" rel="stylesheet" />
  <script src="vendor/select2.js"></script>
  <script src="vendor/select2.optgroupSelect.js"></script>
  <link rel="stylesheet" type="text/css" href="vendor/select2.optgroupSelect.css">
  <link rel="stylesheet" href="vendor/remodal.css">
  <link rel="stylesheet" href="vendor/remodal-default-theme.css">
  <script src="vendor/remodal.min.js"></script>

</head>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.region_l1 {
  font-weight: bold;
}

.region_l2 {
  margin-left: 1em;
}

.region_l3 {
  margin-left: 2em;
}

.region_l4 {
  margin-left: 3em;
}

.remodal {
  text-align: left;
  font-size: 14px;
}
.remodal-confirm {
  margin-top: 25px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

.tooltip{
  text-anchor: middle;
  font-family: sans-serif;
  font-size: 10px;
  font-weight: bold;
  fill:black;
  pointer-events: none;
}

label {
  top: 222px;
  right: 35px;
  color: #D8D8D8;
}

.roundbox {
  background-color: #eee;
  padding: 20px;
  margin-right: 20px;
  text-align: center;
  border-radius: 15px;
  display: inline-block;
}


.switch-field {
  font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
  overflow: hidden;
}

.switch-title {
  margin-bottom: 6px;
}

.switch-field input {
  position: absolute !important;
  clip: rect(0, 0, 0, 0);
  height: 1px;
  width: 1px;
  border: 0;
  overflow: hidden;
}

.switch-field label {
  float: left;
}

.switch-field label {
  display: inline-block;
  width: 60px;
  background-color: #e4e4e4;
  color: rgba(0, 0, 0, 0.6);
  font-size: 14px;
  font-weight: normal;
  text-align: center;
  text-shadow: none;
  padding: 6px 14px;
  border: 1px solid rgba(0, 0, 0, 0.2);
  -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1);
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1);
  -webkit-transition: all 0.1s ease-in-out;
  -moz-transition:    all 0.1s ease-in-out;
  -ms-transition:     all 0.1s ease-in-out;
  -o-transition:      all 0.1s ease-in-out;
  transition:         all 0.1s ease-in-out;
}

.button {
  display: inline-block;
  width: 60px;
  background-color: #e4e4e4;
  color: rgba(0, 0, 0, 0.6);
  font-size: 14px;
  font-weight: normal;
  text-align: center;
  text-shadow: none;
  padding: 6px 14px;
  margin-top: 2px;
  margin-bottom: auto;
  vertical-align: sub;
}

.switch-field label:hover {
  cursor: pointer;
}

.switch-field input:checked + label {
  background-color: #A5DC86;
  -webkit-box-shadow: none;
  box-shadow: none;
}

.switch-field label:first-of-type {
  border-radius: 4px 0 0 4px;
}

.switch-field label:last-of-type {
  border-radius: 0 4px 4px 0;
}

#loader {
  border: 16px solid #f3f3f3; /* Light grey */
  border-top: 16px solid #3498db; /* Blue */
  border-radius: 50%;
  width: 120px;
  height: 120px;
  animation: spin 2s linear infinite;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 100px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.select2-search__field {
  width: 250px !important;
}

</style>

<body>

  <div id="loader"></div>

  <div id="loadedcontent" style="display: none;">
    <div id="targetdiv"></div>

    <script type="text/javascript" src="vendor/iframeResizer.contentWindow.min.js" defer></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>

    <script type="text/javascript" src="areas.js"></script>
    <script type="text/javascript" src="visualisation.js"></script>

    <div style="clear:both;"></div>


      <p style="margin-top: 0px; margin-bottom: 30px; font-size: 14px; color: #333333; font-family: HelveticaNeue-Light, Helvetica Neue Light, Helvetica Neue, Helvetica, Arial, Lucida Grande, sans-serif; margin-left: 26px; font-size: 12px;">
      <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQsWHmuNiqqPszC6M47cq_PnhXiWkvfl5PUClS0t2u6yJszzzwUKHJNI623iW2cUMCzLu-MUFwaeI8x/pubhtml?gid=1934247085&single=true">Source data</a>
      </p>

    <div class="roundbox" style="margin-right: 70px;">

      <div style="float: left; margin-right: 40px; margin-bottom: 30px;">

        <p style="text-align: left; margin-top: 0px; margin-bottom: 4px; font-size: 17px; color: #333333; font-weight: bold; font-family: HelveticaNeue-Light, Helvetica Neue Light, Helvetica Neue, Helvetica, Arial, Lucida Grande, sans-serif;">
        Select areas to display
        </p>

        <select multiple='multiple' style="width:250px" id='target'>
          <!--
            <optgroup label="Africa"></optgroup>
            <optgroup label="Asia">
            </optgroup>
            <optgroup label="Central America">
            </optgroup>
            <optgroup label="Europe">
            </optgroup>
            <optgroup label="Middle East">
            </optgroup>
            <optgroup label="North America">
            </optgroup>
            <optgroup label="South America">
            </optgroup>
            <optgroup label="Global">
            <option value="Global">Global resolutions</option>
            </optgroup>
          -->
        </select>

        <input type="button" class="button" onclick="$('#target').select2('val',null); $('#target').trigger({type: 'select2:unselect'});" value="Clear">

      </div>

      <div style="float: left; text-align: left; margin-bottom: 30px;margin-right: 40px;">

        <p style="text-align: left; margin-top: 0px; margin-bottom: 4px; font-size: 17px; color: #333333; font-weight: bold; font-family: HelveticaNeue-Light, Helvetica Neue Light, Helvetica Neue, Helvetica, Arial, Lucida Grande, sans-serif;">
        Select resolution types to display
        </p>

        <select multiple='multiple' style="width:250px" id='target2'>
          <option value="HT">Human Trafficking</option>
          <option value="HS">Human Smuggling</option>
          <option value="DT">Drugs Trafficking</option>
          <option value="AS">Arms Smuggling</option>
          <option value="AT">Arms Trafficking</option>
          <option value="RT">Resource Trafficking</option>
          <option value="WT">Wildlife Trafficking</option>
          <option value="TR">Theft Armed Robbery</option>
          <option value="PI">Piracy</option>
          <option value="GT">Goods Trafficking</option>
          <option value="FC">Financial Crime</option>
          <option value="CC">Cyber Crime</option>
          <option value="TE">Terrorism</option>
          <option value="KN">Kidnapping Abductions</option>
        </select>

        <input type="button" class="button" onclick="$('#target2').select2('val',null)" value="Clear">

      </div>

      <div style="float: left;">

        <p style="margin-top: 0px; margin-bottom: 4px; font-size: 17px; color: #333333; font-weight: bold; font-family: HelveticaNeue-Light, Helvetica Neue Light, Helvetica Neue, Helvetica, Arial, Lucida Grande, sans-serif;">
        Select what is counted in graphs
        <div class="switch-field">
          <input type="radio" id="switch_right" name="switch_2" id="switch_resolutions" value="Resolutions" checked/ />
          <label for="switch_right" style=" width: 80px; ">Resolutions</label>
          <input type="radio" id="switch_left" name="switch_2" id="switch_mentions" value="Mentions">
          <label for="switch_left">Mentions</label>
        </div>
        </p>
        <!--<a href="#modal">Call the modal with data-remodal-id="modal"</a>-->

      </div>
    </div>
  </div>

	<script>
$(function(){
  var inst = $('[data-remodal-id=modal]').remodal();
  inst.close();
  Tabletop.init( { key: publicSpreadsheetUrl,
    callback: load_sheet_data,
    simpleSheet: true } )
  $('#target').select2(
      {
        placeholder: "Displaying all - type to search",
        closeOnSelect: false,
        templateResult: function (data) {
          // We only really care if there is an element to pull classes from
          if (!data.element) {
            return data.text;
          }

          var $element = $(data.element);

          var $wrapper = $('<span></span>');
          $wrapper.addClass($element[0].className);

          $wrapper.text(data.text);

          return $wrapper;
        }
      });
//    $.fn.select2.amd.require(["optgroup-data", "optgroup-results"],
//        function (OptgroupData, OptgroupResults) {
//          $('#target').select2({
//            dataAdapter: OptgroupData,
//            resultsAdapter: OptgroupResults,
//            closeOnSelect: false,
//            placeholder: "Displaying all - type to search"
//          });
//        });
  $('#target2').select2(
      {
        placeholder: "Displaying all - type to search",
        closeOnSelect: false,
      });
});

var get_selected_countries = function() {
  var vals = $('#target').select2('data')
  var country_selections = []
  vals.forEach(function (e) { country_selections.push(e.text) });
  if(country_selections.length == 0) { return top_regions; }
  return country_selections;
}
var get_selected_types = function() {
  var vals = $('#target2').select2('data')
  var type_selections = []
  vals.forEach(function (e) {
    type_selections.push(e.id)
  });
  if(type_selections.length == 0) { return types; }
  return type_selections;
}

var remove_from_selections = function(selections, new_area) {
  return new_selections;
}

var update_selections = function() {
  update_data(get_selected_countries(), get_selected_types());
  $('#target').trigger('change');
}

var find_select = function(value) {
  return $('#target').find("option[value='" + value + "']");
}

var old_values = [];
//$('#target').on('change', function (evt) {
$('#target').on("select2:select", function(event) {
  var values = [];
  // copy all option values from selected
  $(event.currentTarget).find("option:selected").each(function(i, selected){
    values[i] = $(selected).text();
  });
  // doing a diff of old_values gives the new values selected
  var new_area = $(values).not(old_values).get()[0];
  // remove all parents and children of added area
  // remove all children of added area
  if(new_area) {
    new_values = [];
    console.log('old '+old_values);
    console.log('last '+new_area);
    old_values.forEach(function(c) {
      if (area_is_part_of(c, new_area) || area_is_parent_of(c, new_area)) {
        find_select(c).removeAttr("selected");
        find_select(c).attr("aria-selected", "false");
        $("#target").select2("close");
        $("#target").select2("open");
      } else {
        new_values.push(c);
      }
    });
    console.log('new '+new_values);
    new_values.push(new_area);
  } else {
    new_values = old_values;
  }
  $('#target').val(new_values);
  $('#target').trigger('change');
  // update old_values for future use
  old_values = new_values;
  update_selections();
  global_tree.contains(print_tree, Tree.prototype.traverse_with_depth)
});
$('#target').on("select2:unselect", function(event) {
  vals = $('#target').val();
  old_values = vals;
  if(!old_values) { old_values = []; }
  update_selections();
});

//$('#target').on("change", function(event) {
//  vals = $('#target').val();
//  if('Chad' in vals) {
//    find_select('Chad').prop('selected', false)
//    find_select('Chad').attr("aria-selected", false);
//    $('#target').val('Africa');
//    $('#target').trigger('change');
//    $("#target").select2("open");
//  }
//});


  // make sure that we don't simultaneously select regions and parts of regions
//  var vals = $('#target').val();
//  if(vals && vals.length > 1) {
//    vals.forEach(function(v) {
//      vals.forEach(function(v2) {
//        if(area_is_part_of(v,v2)) {
//          remove_from_selections(v);
//        }
//      });
//    });
//  }
//});
$('#target2').on('change', function (evt) {
  update_selections();
});


$('input:radio[name="switch_2"]').change(
    function(){
        if (this.checked && this.value == 'Mentions') {
          switch_view('mentions','types');
        }
        if (this.checked && this.value == 'Resolutions') {
          switch_view('resolutions','countries');
        }
    });
	</script>


<div class="remodal" data-remodal-id="modal">
</div>

</body>
